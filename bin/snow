#!/bin/bash
#set -xv
# This is the sNow! Command Line Interface 
# Developed by Jordi Blasco <jordi.blasco@hpcnow.com>
# For more information, visit the official website : www.hpcnow.com/snow
#

SNOWPATH=$(dirname "$0")
# Load the configuration
CONFIG_FILE=$SNOWPATH/../etc/snow/snow.conf
SNOW_MODULES=$SNOWPATH/../etc/active-modules.conf
opt1=$1
opt2=$2
opt3=$3

if [[ -f $CONFIG_FILE ]]; then
    source $CONFIG_FILE
fi

if [[ -f $SNOW_MODULES ]]; then
    source $SNOW_MODULES
fi

if [[ -d $SNOWROOT/log ]]; then
    mkdir $SNOWROOT/log
fi

function shelp(){
echo " 
This is the sNow! Command Line Interface
Developed by Jordi Blasco <jordi.blasco@hpcnow.com>
For more information, visit the official website : www.hpcnow.com

Usage: snow [function] <option|module|server>

Function List:

    * config                       | updates the sNow! configuration based on the snow.conf, /etc/hosts and active-modules.conf
    * update tools                 | updates the sNow! Tools from the public HPCNow! GIT repo
    * install base                 | installs the basic software to deploy VMs, cluster filesystem nodes and compute nodes
    * install <module|server>      | installs specific module or server 
    * update <module|server>       | updates specific module or server
    * update configspace           | updates configuration files from public git repo
    * list                         | list current services and the status
    * takeover                     | migrates VMs and critical services to other nodes
    * boot <module|server>         | boot specific module or server
    * boot services                | boot all the services
    * boot cluster <clustername>   | boot all the compute nodes (by default 20 nodes at once)
    * reboot <module|server>       | reboot specific module or server
    * shutdown <module|server>     | shutdown specific module or server
    * destroy <module|server>      | force to stop specific module or server
    * console <module|server>      | console access to specific module or server
    * uptime <module|sever>        | shows uptime of specific module or server

Examples:

    snow update tools
    snow install base
    snow install ldap
"
}

#function check_interfaces() {
#ip show ${BRIDGEMAP[xpub0]}
#}

function config() {
#check_interfaces
if ! [[ -f $SNOW_MODULES ]]; then
    echo "No $SNOW_MODULES found"
else
    #fai         none  7,3
    cat $SNOWROOT/snow-tools/etc/snow/active-modules.conf | grep -v ^# |  gawk '{print $1" "}'
fi
}

function update_tools() {
if ! [[ -d $SNOWROOT/snow-tools ]]; then
    mkdir -p $SNOWROOT
    cd $SNOWROOT
    git clone http://bitbucket.org/hpcnow/snow-tools.git
    cd -
else
    cd $SNOWROOT/snow-tools
    git pull http://bitbucket.org/hpcnow/snow-tools.git
fi 
}

function update_configspace() {
if ! [[ -d $SNOWROOT/snow-configspace  ]]; then
    mkdir -p $SNOWROOT
    cd $SNOWROOT
    git clone http://bitbucket.org/hpcnow/snow-configspace.git
    cd -
else
    cd $SNOWROOT/snow-configspace
    git pull http://bitbucket.org/hpcnow/snow-configspace.git
fi
}

function xen_create() {
    VNAME=$1
    echo xen-create-image --config=/sNow/snow-tools/etc/xen-tools.conf --roledir=/sNow/snow-tools/etc/role.d                \
                    --hostname=$1 --mac=${VNAME[4]} --bridge=${VNAME[3]} --ip=${VNAME[2]} --gateway=${VNAME[5]} --netmask=${VNAME[6]} \
                    --role=udev,snow,${VNAME[0]} --accounts --copyhosts --genpass=0 $FORCE
}

function install_base() {
    if [[ "$opt3" == "force" ]]
    then 
        FORCE="--force"
    fi 
    xen_create deploy
}

function install() {
    echo install
}

function update() {
    echo update
}

function list() {
    echo list
}

function takeover() {
    echo takeover
}

function boot() {
    echo boot
}

function get_server_distribution(){
    echo get_server_distro
}

function boot_services() {
    get_server_distribution
    for i in $(SELF_ACTIVE_MODULES)
    do 
        ssh server[$i] xm create $SNOWROOT/etc/xen/$i.cfg
    done
}

function boot_cluster() {
    CLUSTERNAME=$2
    echo boot_cluster 
}

function nreboot() {
    pdsh -w $2 reboot
}

function nshutdown() {
    ssh $2 halt
}

function ndestroy() {
    get_server_distribution
    if vm ; then 
        xm destroy $2
    else
        ipmitool -H $2 -U $IPMIUSER -P $PIMIPWD power down
    fi
}

function nconsole() {
    get_server_distribution
    if vm ; then
        xm console $2
    else
        ipmitool -H $2 -U $IPMIUSER -P $PIMIPWD console activate
    fi
}

function nuptime() {
    pdsh -w $2 uptime 
}

#
# End Functions
#

#
# Start Cases
#
case $opt1 in
    update)
        case $opt2 in
            tools)
                update_tools
            ;;
            configspace)
                update_configspace
            ;;
            *)
                update $opt3
            ;;
        esac
    ;;
    install)
        case $opt2 in
            base)
                install_base
            ;;
            *)
                install $opt2
            ;;
        esac
    ;;
    list)
        list $opt2
    ;;
    takeover)
        takeover $opt2
    ;;
    boot)
        case $opt2 in
            services)  
                boot_services $opt3 
            ;;
            cluster)
                boot_cluster $opt3 
            ;;
            *)
                boot $opt3 
            ;;
        esac
    ;;
    reboot)
        nreboot $opt2
    ;;
    shutdown)
        nshutdown $opt2
    ;;
    destroy)
        ndestroy $opt2
    ;;
    console)
        nconsole $opt2
    ;;
    uptime)
        nuptime $opt2
    ;;
    help|\?)
      shelp
      ;;
  esac

#
# End Cases
#

#
# Log the sNow! activity
#

#echo "$(date)    $USER    $@" >> $SNOWROOT/log/snow_actions.log 
