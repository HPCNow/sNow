#!/bin/bash
# Configure the new image for sNow! HPC suite
# Developed by HPCNow! www.hpcnow.com
# Jordi Blasco
#

prefix=$1

#  Source our common functions - this will let us install a Debian package.
if [ -e /usr/share/xen-tools/common.sh ]; then
    . /usr/share/xen-tools/common.sh
else
    echo "Installation problem"
fi
# Load sNow! configuration
if [ -e /sNow/snow-tools/etc/snow.conf ]; then
    . /sNow/snow-tools/etc/snow.conf
else
    echo "The /sNow/snow-tools/etc/snow.conf is not available."
    echo "Please use the /sNow/snow-tools/etc/snow.conf-example to setup your environment."
    exit 1
fi

# Default Config Manager is snow01.
SNOWCM=${SNOWCM:-cfengine3}
CF_SERVER=${CF_SERVER:-snow01}

#  Update APT lists.
#chroot ${prefix} /usr/bin/apt-get update
# CFEngine community repos
if  [[ "$SNOWCM" == "cfengine3" ]]; then 
    # There is a bug in the CFEngine debian repos. Using package instead
    CFENGINE_VER="3.7.2-1"
    #wget http://cfengine.com/pub/gpg.key -O ${prefix}/tmp/gpg.key
    #chroot ${prefix} /usr/bin/apt-key add /tmp/gpg.key
    #/bin/echo "deb http://cfengine.com/pub/apt/packages stable main" > ${prefix}/etc/apt/sources.list.d/cfengine-community.list
    #chroot ${prefix} /usr/bin/apt-get update
    #chroot ${prefix} /usr/bin/apt-get install cfengine-community debian-keyring
    wget --no-check-certificate https://cfengine-package-repos.s3.amazonaws.com/community_binaries/cfengine-community_${CFENGINE_VER}_amd64.deb -O ${prefix}/tmp/cfengine-community_${CFENGINE_VER}_amd64.deb
    chroot ${prefix} /usr/bin/dpkg -i /tmp/cfengine-community_${CFENGINE_VER}_amd64.deb
    cp -p /sNow/snow-tools/etc/role.d/boot/cf_boot.service  ${prefix}/lib/systemd/system/cf_boot.service
    cp -p /sNow/snow-tools/etc/role.d/boot/cf_boot  ${prefix}/usr/local/bin/cf_boot
    sed -i "s/__CF_SERVER__/$CF_SERVER/g" ${prefix}/usr/local/bin/cf_boot
    chmod 700 ${prefix}/usr/local/bin/cf_boot
    chroot ${prefix} systemctl enable cf_boot
fi

